<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Builder</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load jsPDF library for in-browser PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* General Styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { border-left: 4px solid #3b82f6; }
        .input-group label { font-weight: 600; font-size: 0.9rem; color: #1f2937; margin-bottom: 4px; display: block; }
        
        /* Default Input Styling (Applied to inputs without error) */
        .base-input-style { 
            width: 100%; 
            padding: 8px 12px; 
            border: 1px solid #d1d5db; 
            border-radius: 8px; 
            font-size: 1rem; 
            transition: border-color 0.2s, box-shadow 0.2s; 
        }
        .base-input-style:focus { 
            border-color: #3b82f6; 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); 
        }

        /* Error Input Styling */
        .error-input {
            border-color: #ef4444 !important; /* Red */
        }
        .error-input:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5) !important;
        }

        /* Custom Styles for Rendered List Descriptions */
        .experience-description ul, .achievement-description ul {
            list-style: disc;
            margin-left: 1.25rem;
            margin-top: 0.5rem;
            padding-left: 0; /* Ensures clean alignment */
            font-size: 0.95rem; /* Slightly smaller for compactness */
            color: #4b5563;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-6 text-center">Resume Builder</h1>
        <p class="text-center text-lg text-gray-600 mb-10">Enter your professional data below to generate your PDF resume instantly.</p>

        <!-- Main Form Wrapper -->
        <form id="resume-form" class="space-y-10">
            
            <!-- 1. Personal Information -->
            <div class="card p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 pl-4 mb-6">1. Personal Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4">
                    <div class="input-group">
                        <label for="full-name">Full Name</label>
                        <input type="text" id="full-name" placeholder="Bridget Sarah Nazi" class="base-input-style">
                    </div>
                    <div class="input-group">
                        <label for="role-applied">Role Applying For</label>
                        <input type="text" id="role-applied" placeholder="Senior Backend Developer" class="base-input-style">
                    </div>
                    <div class="input-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" placeholder="bsarahnazi@gamil.com" class="base-input-style">
                    </div>
                    <div class="input-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" placeholder="09050772152" class="base-input-style">
                    </div>
                    <div class="input-group">
                        <label for="linkedin">LinkedIn Profile URL</label>
                        <input type="url" id="linkedin" placeholder="https://linkedin.com/in/" class="base-input-style">
                    </div>
                    <div class="input-group">
                        <label for="github">GitHub Profile URL</label>
                        <input type="url" id="github" placeholder="https://github.com/arahvii/Resume_builder" class="base-input-style">
                    </div>
                    <div class="input-group">
                        <label for="website">Portfolio/Website URL</label>
                        <input type="url" id="website" placeholder="https://portfolio.com/" class="base-input-style">
                    </div>
                    <div class="input-group">
                        <label for="location">Personal Address (City, Country)</label>
                        <input type="text" id="location" placeholder="Cagayan de Oro, Philippines" class="base-input-style">
                    </div>
                    <!-- Updated: Image File Input -->
                    <div class="input-group md:col-span-2">
                        <label for="image-file">Profile Picture (PNG or JPEG, max 1MB)</label>
                        <input type="file" id="image-file" accept="image/jpeg, image/png" class="base-input-style p-2">
                    </div>
                    <div class="input-group md:col-span-2">
                        <label for="summary">Professional Summary (4-5 lines)</label>
                        <textarea id="summary" rows="4" placeholder="Skilled Backend Software Developer proficient in building and maintaining robust, high-performance systems..." class="base-input-style"></textarea>
                    </div>
                </div>
            </div>

            <!-- 2. Experience -->
            <div class="card p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 pl-4 mb-6">2. Experience</h2>
                
                <!-- Experience List -->
                <div id="experience-list" class="space-y-4 mb-6 p-4">
                    <!-- Dynamic list items will go here -->
                </div>

                <!-- Add New Experience Form -->
                <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg shadow-inner">
                    <h3 class="text-lg font-medium text-blue-800 mb-4">Add New Experience</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="exp-title">Job Title</label>
                            <input type="text" id="exp-title" placeholder="Software Developer" class="base-input-style">
                        </div>
                        <div class="input-group">
                            <label for="exp-company">Company</label>
                            <input type="text" id="exp-company" placeholder="TechSoup" class="base-input-style">
                        </div>
                        <div class="input-group">
                            <label for="exp-start-date">Start Date (YYYY-MM)</label>
                            <input type="month" id="exp-start-date" class="base-input-style">
                        </div>
                        <div class="input-group">
                            <label for="exp-end-date">End Date (YYYY-MM or Leave blank for 'Present')</label>
                            <input type="month" id="exp-end-date" class="base-input-style">
                        </div>
                        <div class="input-group md:col-span-2">
                            <label for="exp-description">Description (One bullet point per line)</label>
                            <textarea id="exp-description" rows="5" placeholder="Highlight your accomplishments, using numbers if possible." class="base-input-style"></textarea>
                        </div>
                    </div>
                    <button type="button" id="add-experience-btn"
                        class="mt-4 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md w-full md:w-auto">
                        Add Experience
                    </button>
                </div>
            </div>

            <!-- 3. Education -->
            <div class="card p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 pl-4 mb-6">3. Education</h2>
                
                <!-- Education List -->
                <div id="education-list" class="space-y-4 mb-6 p-4">
                    <!-- Dynamic list items will go here -->
                </div>

                <!-- Add New Education Form -->
                <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg shadow-inner">
                    <h3 class="text-lg font-medium text-blue-800 mb-4">Add New Education</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="edu-degree">Degree / Field of Study</label>
                            <input type="text" id="edu-degree" placeholder="BSIT" class="base-input-style">
                        </div>
                        <div class="input-group">
                            <label for="edu-school">School / University</label>
                            <input type="text" id="edu-school" placeholder="University of the Philippines" class="base-input-style">
                        </div>
                        <div class="input-group">
                            <label for="edu-start-date">Start Date (YYYY-MM)</label>
                            <input type="month" id="edu-start-date" class="base-input-style">
                        </div>
                        <div class="input-group">
                            <label for="edu-end-date">End Date (YYYY-MM or Leave blank for 'Present')</label>
                            <input type="month" id="edu-end-date" class="base-input-style">
                        </div>
                    </div>
                    <button type="button" id="add-education-btn"
                        class="mt-4 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md w-full md:w-auto">
                        Add Education
                    </button>
                </div>
            </div>

            <!-- 4. Skills (Simplified Input) -->
            <div class="card p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 pl-4 mb-6">4. Skills (Programming Languages)</h2>
                <p class="text-gray-500 pl-4 mb-6">
                    Skills will be displayed under the "Programming Languages" category in the PDF.
                </p>
                
                <!-- Skills List -->
                <div id="skills-list" class="space-y-4 mb-6 p-4">
                    <!-- Dynamic skill tags will go here -->
                </div>

                <!-- Add New Skill Form (Category removed) -->
                <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg shadow-inner">
                    <h3 class="text-lg font-medium text-blue-800 mb-4">Add New Skill</h3>
                    <div class="input-group">
                        <label for="skill-name" class="block text-sm font-medium text-gray-700 mb-1">Skill Name (e.g., 'Python', 'JavaScript', 'SQL'. Separate with commas for multiple.)</label>
                        <input type="text" id="skill-name" placeholder="Python, JavaScript, Flask" class="base-input-style">
                    </div>
                    <button type="button" id="add-skill-btn"
                        class="mt-4 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md w-full md:w-auto">
                        Add Skill
                    </button>
                </div>
            </div>

            <!-- 5. Key Achievements -->
            <div class="card p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 pl-4 mb-6">5. Key Achievements</h2>
                <p class="text-gray-500 pl-4 mb-6">
                    Quantifiable accomplishments and results (use a clear title and description).
                </p>

                <div id="achievements-list" class="space-y-4 mb-6 p-4">
                    <!-- Achievement items will be added here -->
                </div>
                
                <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg shadow-inner">
                    <h3 class="text-lg font-medium text-blue-800 mb-4">Add New Achievement</h3>
                    
                    <div class="mb-4">
                        <label for="achievement-name" class="block text-sm font-medium text-gray-700 mb-1">
                            Achievement Name (e.g., Performance Optimization)
                        </label>
                        <input type="text" id="achievement-name" placeholder="A concise title for the achievement"
                            class="base-input-style">
                    </div>

                    <div class="mb-4">
                        <label for="achievement-description" class="block text-sm font-medium text-gray-700 mb-1">
                            Achievement Description (One bullet point per line)
                        </label>
                        <textarea id="achievement-description" rows="3"
                            placeholder="Detailed description of the achievement and contribution (e.g., Reduced database latency by 40\%)."
                            class="base-input-style"></textarea>
                    </div>

                    <button type="button" id="add-achievement-btn"
                        class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md">
                        Add Key Achievement
                    </button>
                </div>
            </div>

            <!-- 6. Courses & Training -->
            <div class="card p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 pl-4 mb-6">6. Courses & Training</h2>
                
                <!-- Courses List -->
                <div id="course-list" class="space-y-4 mb-6 p-4">
                    <!-- Dynamic course items will go here -->
                </div>

                <!-- Add New Course Form -->
                <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg shadow-inner">
                    <h3 class="text-lg font-medium text-blue-800 mb-4">Add New Course</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="course-name">Course Name</label>
                            <input type="text" id="course-name" placeholder="e.g., AWS Certified Developer - Associate" class="base-input-style">
                        </div>
                        <div class="input-group">
                            <label for="course-institution">Issuing Institution</label>
                            <input type="text" id="course-institution" placeholder="e.g., Amazon Web Services (AWS)" class="base-input-style">
                        </div>
                    </div>
                    <button type="button" id="add-course-btn"
                        class="mt-4 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md w-full md:w-auto">
                        Add Course/Training
                    </button>
                </div>
            </div>

            <!-- 7. Interests -->
            <div class="card p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 pl-4 mb-6">7. Interests</h2>
                
                <!-- Interests List -->
                <div id="interest-list" class="flex flex-wrap gap-2 mb-6 p-4">
                    <!-- Dynamic interest tags will go here -->
                </div>

                <!-- Add New Interest Form -->
                <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg shadow-inner">
                    <h3 class="text-lg font-medium text-blue-800 mb-4">Add New Interest</h3>
                    <div class="input-group">
                        <label for="interest-name">Interest / Passion</label>
                        <input type="text" id="interest-name" placeholder="e.g., Security & Cryptography, Gaming" class="base-input-style">
                    </div>
                    <button type="button" id="add-interest-btn"
                        class="mt-4 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md w-full md:w-auto">
                        Add Interest
                    </button>
                </div>
            </div>

            <!-- 8. Languages (Simplified Input) -->
            <div class="card p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 pl-4 mb-6">8. Languages</h2>
                
                <!-- Languages List -->
                <div id="language-list" class="space-y-4 mb-6 p-4">
                    <!-- Dynamic language items will go here -->
                </div>

                <!-- Add New Language Form -->
                <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg shadow-inner">
                    <h3 class="text-lg font-medium text-blue-800 mb-4">Add New Language</h3>
                    <div class="input-group">
                        <label for="lang-entry">Language and Proficiency (e.g., English - Native, Spanish - Intermediate)</label>
                        <input type="text" id="lang-entry" placeholder="English - Native" class="base-input-style">
                    </div>
                    <button type="button" id="add-language-btn"
                        class="mt-4 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md w-full md:w-auto">
                        Add Language
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6 pt-8 pb-12">
                <button type="submit" id="save-data-btn"
                    class="px-12 py-4 bg-green-600 text-white text-xl font-bold rounded-full hover:bg-green-700 transition duration-300 shadow-xl shadow-green-300/50">
                    Save Resume Data
                </button>
                <button type="button" id="generate-pdf-btn"
                    class="px-12 py-4 bg-purple-600 text-white text-xl font-bold rounded-full hover:bg-purple-700 transition duration-300 shadow-xl shadow-purple-300/50">
                    Generate & Download PDF
                </button>
            </div>
            
        </form>
    </div>

    <!-- Status Message Container (for error/success feedback) -->
    <div id="status-message" class="fixed bottom-4 right-4 p-4 rounded-lg text-white shadow-lg z-50 hidden transition-opacity duration-300"></div>

    <script type="module">
        // Import jsPDF from the window object
        const { jsPDF } = window.jspdf;

        // --- State Management ---
        const state = {
            personal: {
                imageData: '' // Holds Base64 string of the uploaded image
            },
            experience: [],
            education: [],
            skills: [], // Stores only names now
            achievements: [], 
            courses: [],
            interests: [],
            languages: [] // Stores objects with 'entry' text (e.g., "English - Fluent")
        };

        // --- DOM Elements ---
        const form = document.getElementById('resume-form');
        const statusMessage = document.getElementById('status-message');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');

        // Lists
        const experienceList = document.getElementById('experience-list');
        const educationList = document.getElementById('education-list');
        const skillsList = document.getElementById('skills-list');
        const achievementsList = document.getElementById('achievements-list');
        const courseList = document.getElementById('course-list');
        const interestList = document.getElementById('interest-list');
        const languageList = document.getElementById('language-list');

        // Inputs
        const inputs = {
            // Personal
            fullName: document.getElementById('full-name'),
            roleApplied: document.getElementById('role-applied'),
            email: document.getElementById('email'),
            phone: document.getElementById('phone'),
            linkedin: document.getElementById('linkedin'),
            github: document.getElementById('github'),
            website: document.getElementById('website'),
            location: document.getElementById('location'),
            summary: document.getElementById('summary'),
            imageFile: document.getElementById('image-file'), // UPDATED: File input reference
            
            // Experience
            expTitle: document.getElementById('exp-title'),
            expCompany: document.getElementById('exp-company'),
            expStartDate: document.getElementById('exp-start-date'),
            expEndDate: document.getElementById('exp-end-date'),
            expDescription: document.getElementById('exp-description'),

            // Education
            eduDegree: document.getElementById('edu-degree'),
            eduSchool: document.getElementById('edu-school'),
            eduStartDate: document.getElementById('edu-start-date'),
            eduEndDate: document.getElementById('edu-end-date'),

            // Skills (Simplified)
            skillName: document.getElementById('skill-name'),

            // Achievements
            achievementName: document.getElementById('achievement-name'),
            achievementDescription: document.getElementById('achievement-description'),

            // Courses
            courseName: document.getElementById('course-name'),
            courseInstitution: document.getElementById('course-institution'),

            // Interests
            interestName: document.getElementById('interest-name'),

            // Languages (Simplified)
            langEntry: document.getElementById('lang-entry'),
        };

        // --- Utility Functions ---

        // Expose globally for inline onclick
        window.showMessage = (message, type = 'success') => {
            let className = '';
            if (type === 'success') {
                className = 'bg-green-500';
            } else if (type === 'error') {
                className = 'bg-red-500';
            } else if (type === 'info') {
                className = 'bg-blue-500';
            }
            statusMessage.textContent = message;
            statusMessage.className = `fixed bottom-4 right-4 p-4 rounded-lg text-white shadow-lg z-50 transition-opacity duration-300 ${className}`;
            statusMessage.classList.remove('hidden', 'opacity-0');
            statusMessage.classList.add('opacity-100');

            setTimeout(() => {
                statusMessage.classList.remove('opacity-100');
                statusMessage.classList.add('opacity-0');
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 300);
            }, 4000);
        };

        // Expose globally for inline onclick
        window.generateItemId = () => crypto.randomUUID();
        
        // Helper to format date strings for PDF
        const formatDate = (dateString) => {
            if (dateString === 'Present') return 'Present';
            if (!dateString) return '';
            try {
                // Input format is YYYY-MM
                const [year, month] = dateString.split('-');
                if (year && month) {
                    const monthName = new Date(year, parseInt(month) - 1).toLocaleString('en-us', { month: 'short' });
                    return `${monthName} ${year}`;
                }
                return dateString; // Return as-is if parsing fails
            } catch (e) {
                return dateString;
            }
        };

        // --- Renderer Functions (for displaying data in the form) ---

        const renderExperience = () => {
            experienceList.innerHTML = state.experience.length === 0 ? 
                '<p class="text-gray-400 italic p-4">No experience added yet.</p>' : '';
            
            state.experience.sort((a, b) => (b.endDate === 'Present' ? 1 : b.endDate.localeCompare(a.endDate))).forEach((exp) => {
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 bg-gray-50 rounded-lg flex justify-between items-start';
                
                const descriptionHtml = exp.description.split('\n').map(line => line.trim() ? `<li>${line.trim()}</li>` : '').join('');

                div.innerHTML = `
                    <div class="w-full">
                        <p class="font-semibold text-lg text-gray-800">${exp.title} at ${exp.company}</p>
                        <p class="text-sm text-gray-600 mb-2">${formatDate(exp.startDate)} - ${formatDate(exp.endDate)}</p>
                        <div class="experience-description"><ul>${descriptionHtml}</ul></div>
                    </div>
                    <button type="button" onclick="removeItem('experience', '${exp.id}')" 
                        class="flex-shrink-0 text-red-500 hover:text-red-700 text-sm ml-4 p-1 rounded-full hover:bg-red-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                experienceList.appendChild(div);
            });
        };

        const renderEducation = () => {
            educationList.innerHTML = state.education.length === 0 ? 
                '<p class="text-gray-400 italic p-4">No education added yet.</p>' : '';
            
            state.education.sort((a, b) => (b.endDate === 'Present' ? 1 : b.endDate.localeCompare(a.endDate))).forEach((edu) => {
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 bg-gray-50 rounded-lg flex justify-between items-start';
                
                div.innerHTML = `
                    <div>
                        <p class="font-semibold text-lg text-gray-800">${edu.degree} at ${edu.school}</p>
                        <p class="text-sm text-gray-600">${formatDate(edu.startDate)} - ${formatDate(edu.endDate)}</p>
                    </div>
                    <button type="button" onclick="removeItem('education', '${edu.id}')" 
                        class="text-red-500 hover:text-red-700 text-sm ml-4 p-1 rounded-full hover:bg-red-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                educationList.appendChild(div);
            });
        };

        const renderSkills = () => {
            skillsList.innerHTML = state.skills.length === 0 ? 
                '<p class="text-gray-400 italic p-4 w-full">No skills added yet.</p>' : '';

            // Since skill category input is removed, we treat all skills as one list for display
            state.skills.forEach(skill => {
                const skillSpan = document.createElement('span');
                skillSpan.className = 'inline-flex items-center px-3 py-1 mr-2 text-sm font-medium bg-blue-100 text-blue-800 rounded-full cursor-pointer hover:bg-red-100 hover:text-red-800 transition duration-150';
                skillSpan.textContent = skill.name;
                // Note: removeItem is global now
                skillSpan.onclick = () => window.removeItem('skills', skill.id); 
                skillsList.appendChild(skillSpan);
            });
        };

        const renderAchievements = () => {
            achievementsList.innerHTML = state.achievements.length === 0 ? 
                '<p class="text-gray-400 italic p-4">No key achievements added yet.</p>' : '';
            
            state.achievements.forEach((ach) => {
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 bg-gray-50 rounded-lg flex justify-between items-start';
                
                const descriptionHtml = ach.description.split('\n').map(line => line.trim() ? `<li>${line.trim()}</li>` : '').join('');

                div.innerHTML = `
                    <div class="w-full">
                        <p class="font-semibold text-gray-800 mb-2">${ach.name}</p>
                        <div class="achievement-description"><ul>${descriptionHtml}</ul></div>
                    </div>
                    <button type="button" onclick="removeItem('achievements', '${ach.id}')" 
                        class="flex-shrink-0 text-red-500 hover:text-red-700 text-sm ml-4 p-1 rounded-full hover:bg-red-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                achievementsList.appendChild(div);
            });
        };


        const renderCourses = () => {
            courseList.innerHTML = state.courses.length === 0 ? 
                '<p class="text-gray-400 italic p-4">No courses or training added yet.</p>' : '';
            
            state.courses.forEach((course) => {
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 bg-gray-50 rounded-lg flex justify-between items-start';
                
                div.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${course.name}</p>
                        <p class="text-sm text-gray-600">${course.institution}</p>
                    </div>
                    <button type="button" onclick="removeItem('courses', '${course.id}')" 
                        class="text-red-500 hover:text-red-700 text-sm ml-4 p-1 rounded-full hover:bg-red-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                courseList.appendChild(div);
            });
        };

        const renderInterests = () => {
            interestList.innerHTML = state.interests.length === 0 ? 
                '<p class="text-gray-400 italic p-4 w-full">No interests added yet.</p>' : '';
            
            state.interests.forEach(interest => {
                const interestSpan = document.createElement('span');
                interestSpan.className = 'inline-flex items-center px-3 py-1 text-sm font-medium bg-purple-100 text-purple-800 rounded-full cursor-pointer hover:bg-red-100 hover:text-red-800 transition duration-150';
                interestSpan.textContent = interest.name;
                // Note: removeItem is global now
                interestSpan.onclick = () => window.removeItem('interests', interest.id);
                interestList.appendChild(interestSpan);
            });
        };

        const renderLanguages = () => {
            languageList.innerHTML = state.languages.length === 0 ? 
                '<p class="text-gray-400 italic p-4">No languages added yet.</p>' : '';
            
            state.languages.forEach((lang) => {
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 bg-gray-50 rounded-lg flex justify-between items-start';
                
                div.innerHTML = `
                    <div class="flex items-center justify-between w-full">
                        <p class="font-semibold text-gray-800">${lang.entry}</p>
                    </div>
                    <button type="button" onclick="removeItem('languages', '${lang.id}')" 
                        class="text-red-500 hover:text-red-700 text-sm ml-4 p-1 rounded-full hover:bg-red-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                languageList.appendChild(div);
            });
        };

        // Expose globally for form updates
        window.renderAll = () => {
            renderExperience();
            renderEducation();
            renderSkills();
            renderAchievements(); 
            renderCourses();
            renderInterests();
            renderLanguages();
        };

        // --- Local Storage Persistence ---
        const LOCAL_STORAGE_KEY = 'resumeBuilderData';

        const saveDataLocally = () => {
            try {
                // Save the entire state object to local storage
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
                window.showMessage("Resume data saved successfully to your browser!", 'success');
            } catch (e) {
                console.error("Error saving to local storage: ", e);
                window.showMessage("Failed to save data locally.", 'error');
            }
        };

        const loadDataLocally = () => {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedData) {
                    const loadedData = JSON.parse(storedData);
                    
                    // Assign loaded data to state and input fields
                    Object.assign(state, loadedData);
                    
                    // Load Personal Information into inputs
                    inputs.fullName.value = state.personal.fullName || '';
                    inputs.roleApplied.value = state.personal.roleApplied || '';
                    inputs.email.value = state.personal.email || '';
                    inputs.phone.value = state.personal.phone || '';
                    inputs.linkedin.value = state.personal.linkedin || '';
                    inputs.github.value = state.personal.github || '';
                    inputs.website.value = state.personal.website || '';
                    inputs.location.value = state.personal.location || '';
                    inputs.summary.value = state.personal.summary || '';
                    // The image data is stored in state.personal.imageData (Base64)
                    // We cannot pre-fill a file input for security reasons, so this line is removed.
                    
                    window.renderAll();
                    console.log("Resume data loaded from local storage.");
                } else {
                    console.log("No local resume data found. Starting fresh.");
                    window.renderAll(); 
                }
            } catch (e) {
                console.error("Error loading from local storage: ", e);
                window.showMessage("Failed to load local data.", 'error');
                window.renderAll(); 
            }
        };

        // --- CRUD Functions (unchanged) ---

        // Expose globally for inline onclick
        window.removeItem = (arrayName, itemId) => {
            state[arrayName] = state[arrayName].filter(item => item.id !== itemId);
            window.renderAll();
            saveDataLocally(); // Save immediately after removal
            window.showMessage(`Item removed from ${arrayName}.`, 'info');
        };

        // --- Event Handlers for Adding Items ---

        document.getElementById('add-experience-btn').addEventListener('click', () => {
            const title = inputs.expTitle.value.trim();
            const company = inputs.expCompany.value.trim();
            const startDate = inputs.expStartDate.value.trim();
            const endDate = inputs.expEndDate.value.trim() || 'Present';
            const description = inputs.expDescription.value.trim();

            if (!title || !company || !startDate || !description) {
                window.showMessage('Please fill out Title, Company, Start Date, and Description.', 'error');
                return;
            }

            state.experience.push({ 
                id: window.generateItemId(), 
                title, company, startDate, endDate, description 
            });

            // Clear inputs
            inputs.expTitle.value = '';
            inputs.expCompany.value = '';
            inputs.expStartDate.value = '';
            inputs.expEndDate.value = '';
            inputs.expDescription.value = '';

            window.renderAll();
            saveDataLocally();
            window.showMessage('Experience added!', 'success');
        });

        document.getElementById('add-education-btn').addEventListener('click', () => {
            const degree = inputs.eduDegree.value.trim();
            const school = inputs.eduSchool.value.trim();
            const startDate = inputs.eduStartDate.value.trim();
            const endDate = inputs.eduEndDate.value.trim() || 'Present';

            if (!degree || !school || !startDate) {
                window.showMessage('Please fill out Degree, School, and Start Date.', 'error');
                return;
            }

            state.education.push({ 
                id: window.generateItemId(), 
                degree, school, startDate, endDate 
            });

            // Clear inputs
            inputs.eduDegree.value = '';
            inputs.eduSchool.value = '';
            inputs.eduStartDate.value = '';
            inputs.eduEndDate.value = '';

            window.renderAll();
            saveDataLocally();
            window.showMessage('Education added!', 'success');
        });
        
        // Updated: Simplified Skill Addition
        document.getElementById('add-skill-btn').addEventListener('click', () => {
            const name = inputs.skillName.value.trim();

            if (!name) {
                window.showMessage('Please enter at least one Skill Name.', 'error');
                return;
            }

            const newSkills = name.split(',').map(skillName => ({
                id: window.generateItemId(),
                name: skillName.trim()
            })).filter(skill => skill.name); 

            state.skills.push(...newSkills);

            inputs.skillName.value = '';

            window.renderAll();
            saveDataLocally();
            window.showMessage(`Added ${newSkills.length} skill(s)!`, 'success');
        });

        document.getElementById('add-achievement-btn').addEventListener('click', () => {
            const name = inputs.achievementName.value.trim();
            const description = inputs.achievementDescription.value.trim();
            
            if (!name || !description) {
                window.showMessage('Please fill out both Achievement Name and Description.', 'error');
                return;
            }

            state.achievements.push({
                id: window.generateItemId(),
                name, description
            });

            inputs.achievementName.value = '';
            inputs.achievementDescription.value = '';

            window.renderAll();
            saveDataLocally();
            window.showMessage('Key Achievement added!', 'success');
        });

        document.getElementById('add-course-btn').addEventListener('click', () => {
            const name = inputs.courseName.value.trim();
            const institution = inputs.courseInstitution.value.trim();
            
            if (!name || !institution) {
                window.showMessage('Please fill out both Course Name and Institution.', 'error');
                return;
            }

            state.courses.push({
                id: window.generateItemId(),
                name, institution
            });

            inputs.courseName.value = '';
            inputs.courseInstitution.value = '';

            window.renderAll();
            saveDataLocally();
            window.showMessage('Course/Training added!', 'success');
        });
        
        document.getElementById('add-interest-btn').addEventListener('click', () => {
            const name = inputs.interestName.value.trim();
            
            if (!name) {
                window.showMessage('Please enter an Interest.', 'error');
                return;
            }

            const newInterests = name.split(',').map(interestName => ({
                id: window.generateItemId(),
                name: interestName.trim()
            })).filter(interest => interest.name); 

            state.interests.push(...newInterests);

            inputs.interestName.value = '';

            window.renderAll();
            saveDataLocally();
            window.showMessage(`Added ${newInterests.length} interest(s)!`, 'success');
        });

        // Updated: Simplified Language Addition
        document.getElementById('add-language-btn').addEventListener('click', () => {
            const entry = inputs.langEntry.value.trim();
            
            if (!entry) {
                window.showMessage('Please enter a Language and Proficiency (e.g., English - Fluent).', 'error');
                return;
            }

            state.languages.push({
                id: window.generateItemId(),
                entry
            });

            inputs.langEntry.value = '';

            window.renderAll();
            saveDataLocally();
            window.showMessage('Language added!', 'success');
        });

        // --- Image File Handler ---
        inputs.imageFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                state.personal.imageData = '';
                return;
            }

            // Security/Size Check (1MB limit)
            if (file.size > 1024 * 1024) {
                window.showMessage('Image file is too large (max 1MB).', 'error');
                event.target.value = ''; // Clear file input
                state.personal.imageData = ''; // Clear stored data
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                // Store the Base64 data URL
                state.personal.imageData = e.target.result; 
                window.showMessage('Image loaded successfully!', 'success');
            };
            reader.onerror = () => {
                window.showMessage('Failed to read image file.', 'error');
                state.personal.imageData = '';
            };

            reader.readAsDataURL(file); // Convert file to Base64 data URL
        });


        // --- Main Form Submission Handler ---
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // 1. Gather Personal Info (Always collect from inputs)
            state.personal.fullName = inputs.fullName.value.trim();
            state.personal.roleApplied = inputs.roleApplied.value.trim();
            state.personal.email = inputs.email.value.trim();
            state.personal.phone = inputs.phone.value.trim();
            state.personal.linkedin = inputs.linkedin.value.trim();
            state.personal.github = inputs.github.value.trim();
            state.personal.website = inputs.website.value.trim();
            state.personal.location = inputs.location.value.trim();
            state.personal.summary = inputs.summary.value.trim();
            // state.personal.imageData is handled by the change listener

            // 2. Save all data (Personal + Lists)
            saveDataLocally();
        });

        // --- PDF Generation Logic (using jsPDF) ---
        
        const generatePDFContent = async () => {
            const doc = new jsPDF();
            let y = 15; // Starting Y position (in mm from top of A4 page)
            const margin = 10; // Reduced margin for professional look
            const pageWidth = doc.internal.pageSize.getWidth();
            const column1Start = margin;
            const column2Start = pageWidth / 2 + 5; // Start of right column
            const column1Width = pageWidth / 2 - 15; // Width of left column
            const column2Width = pageWidth / 2 - 15; // Width of right column
            const maxContentY = doc.internal.pageSize.getHeight() - margin;
            
            // Double spacing (2.0x) for 13pt font is approx 7mm line height
            const LINE_HEIGHT_DOUBLE = 7.0; 
            const LINE_HEIGHT_SINGLE = 4.5; // Used for titles/dates
            
            // Define Colors (RGB)
            const COLOR_PRIMARY = [10, 56, 112];    // Dark Blue
            const COLOR_SECONDARY = [255, 140, 0];  // Orange
            const COLOR_TEXT = [74, 74, 74];        // Gray
            const COLOR_HEADER_TEXT = [255, 255, 255]; // White for header background
            
            // Helper to add a new page if content overflows
            const checkY = (requiredSpace, currentColumnY) => {
                // We add 5mm extra buffer to prevent content from being too close to the footer
                if (currentColumnY + requiredSpace > maxContentY) {
                    return maxContentY + 1; // Signal that a new column or page is needed
                }
                return currentColumnY;
            };

            const p = state.personal;
            let currentYLeft = 0;
            let currentYRight = 0;

            // --- 1. Header (Name, Role, Contact, Photo) ---
            
            // Header Background Bar (Dark Blue)
            doc.setFillColor(...COLOR_PRIMARY);
            doc.rect(0, 0, pageWidth, 40, 'F'); 
            
            // Photo Logic (Use Base64 data from file input) - UPDATED
            const photoSize = 20;
            const photoX = pageWidth - margin - photoSize;
            const photoY = 10;
            
            // Check for the stored Base64 image data
            const imageData = state.personal.imageData; // Get Base64 data from state
            
            if (imageData) {
                try {
                    // Extract MIME type from the Base64 data URL
                    const mimeTypeMatch = imageData.match(/^data:image\/([a-zA-Z]+);base64,/);
                    // Use JPEG as fallback if MIME type cannot be reliably determined
                    const imageFormat = mimeTypeMatch && mimeTypeMatch[1] ? mimeTypeMatch[1].toUpperCase() : 'JPEG'; 
                    
                    // Add image to PDF using stored Base64 data
                    doc.addImage(imageData, imageFormat, photoX, photoY, photoSize, photoSize);
                } catch (error) {
                    console.error("Error drawing Base64 image to PDF:", error);
                    // Fallback to placeholder on error
                    doc.setFillColor(200, 200, 200); 
                    doc.rect(photoX, photoY, photoSize, photoSize, 'F');
                    doc.setFontSize(10);
                    doc.setTextColor(50, 50, 50);
                    doc.text("Image\nFailed", photoX + photoSize / 2, photoY + photoSize / 2 - 2, { align: 'center' });
                }
            } else {
                // Default placeholder if no data is provided
                doc.setFillColor(200, 200, 200); 
                doc.rect(photoX, photoY, photoSize, photoSize, 'F');
                doc.setFontSize(10);
                doc.setTextColor(50, 50, 50);
                doc.text("2x2 Photo\nPlaceholder", photoX + photoSize / 2, photoY + photoSize / 2 - 2, { align: 'center' });
            }

            
            // Name (Font Size 28, White)
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(28);
            doc.setTextColor(...COLOR_HEADER_TEXT);
            doc.text(p.fullName.toUpperCase(), pageWidth / 2, 15, { align: 'center' });
            
            // Role (Font Size 14, Orange)
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(14);
            doc.setTextColor(...COLOR_SECONDARY);
            doc.text(p.roleApplied || 'Professional Resume', pageWidth / 2, 22, { align: 'center' });

            // Contact Info (Font Size 11, White)
            doc.setFontSize(11);
            doc.setTextColor(...COLOR_HEADER_TEXT);
            const contactItems = [];
            if (p.phone) contactItems.push(p.phone);
            if (p.email) contactItems.push(p.email);
            if (p.location) contactItems.push(p.location);
            
            const contactLine = contactItems.join(' | ');
            doc.text(contactLine, pageWidth / 2, 29, { align: 'center' });
            
            // Links (Separate line, smaller text)
            doc.setFontSize(9);
            const links = [];
            if (p.linkedin) links.push(`LinkedIn: ${p.linkedin}`);
            if (p.github) links.push(`GitHub: ${p.github}`);
            if (p.website) links.push(`Portfolio: ${p.website}`);
            doc.text(links.join(' | '), pageWidth / 2, 34, { align: 'center' });

            y = 45; // Start main content below header
            currentYLeft = y;
            currentYRight = y;

            // --- Section Helper Function ---
            const addSectionTitle = (x, y, title) => {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(15); // Size 15
                doc.setTextColor(...COLOR_PRIMARY); // Dark Blue
                doc.text(title.toUpperCase(), x, y);
                y += 2;
                // Orange Underline
                doc.setDrawColor(...COLOR_SECONDARY);
                doc.setLineWidth(0.8);
                doc.line(x, y, x + 35, y); // Short, thick orange line
                y += 8; // Increased vertical spacing after title for double spacing
                return y;
            };

            // --- Left Column Sections (Primary) ---

            // 2. Professional Summary
            if (p.summary) {
                currentYLeft = addSectionTitle(column1Start, currentYLeft, 'SUMMARY');
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(13); // Size 13
                doc.setTextColor(...COLOR_TEXT); // Gray
                const summaryLines = doc.splitTextToSize(p.summary, column1Width);
                doc.text(summaryLines, column1Start, currentYLeft);
                currentYLeft += summaryLines.length * LINE_HEIGHT_DOUBLE + 8; // Use 2.0x line height + extra spacing
            }

            // 3. Experience
            if (state.experience.length > 0) {
                currentYLeft = checkY(15, currentYLeft);
                if (currentYLeft > maxContentY) { doc.addPage(); currentYLeft = margin; }
                currentYLeft = addSectionTitle(column1Start, currentYLeft, 'EXPERIENCE');
                
                state.experience.sort((a, b) => (b.endDate === 'Present' ? 1 : b.endDate.localeCompare(a.endDate))).forEach(exp => {
                    currentYLeft = checkY(30, currentYLeft); // Increased check space for double spacing
                    if (currentYLeft > maxContentY) { doc.addPage(); currentYLeft = margin; }

                    // Title (Size 14, Bold, Orange)
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.setTextColor(...COLOR_SECONDARY);
                    doc.text(exp.title, column1Start, currentYLeft);
                    currentYLeft += LINE_HEIGHT_SINGLE; 
                    
                    // Company & Dates (Size 13, Italic, Gray)
                    doc.setFont('helvetica', 'italic');
                    doc.setFontSize(13);
                    doc.setTextColor(...COLOR_TEXT);
                    const dateRange = formatDate(exp.startDate) + ' - ' + formatDate(exp.endDate);
                    doc.text(`${exp.company} | ${dateRange}`, column1Start, currentYLeft);
                    currentYLeft += LINE_HEIGHT_DOUBLE * 0.8; 

                    // Description (Bullet points, Size 13, Normal, Gray)
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(13);
                    const bulletPoints = exp.description.split('\n').filter(line => line.trim());
                    bulletPoints.forEach(line => {
                        const bulletText = ' ' + line.trim();
                        const bulletLines = doc.splitTextToSize(bulletText, column1Width - 4); // Indent 4mm for bullet
                        
                        doc.text(bulletLines, column1Start + 4, currentYLeft);
                        currentYLeft += bulletLines.length * LINE_HEIGHT_DOUBLE; // Use 2.0x line height for bullets
                    });
                    currentYLeft += 6; // Increased space after entry
                });
            }

            // 4. Education
            if (state.education.length > 0) {
                currentYLeft = checkY(15, currentYLeft);
                if (currentYLeft > maxContentY) { doc.addPage(); currentYLeft = margin; }
                currentYLeft = addSectionTitle(column1Start, currentYLeft, 'EDUCATION');

                doc.setFontSize(13);
                state.education.sort((a, b) => (b.endDate === 'Present' ? 1 : b.endDate.localeCompare(a.endDate))).forEach(edu => {
                    currentYLeft = checkY(15, currentYLeft); // Increased check space
                    if (currentYLeft > maxContentY) { doc.addPage(); currentYLeft = margin; }

                    // Degree (Size 14, Bold, Orange)
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.setTextColor(...COLOR_SECONDARY);
                    doc.text(edu.degree, column1Start, currentYLeft);
                    currentYLeft += LINE_HEIGHT_SINGLE; 

                    // Dates (Size 13, Italic, Gray) - MOVED HERE
                    doc.setFont('helvetica', 'italic');
                    doc.setFontSize(13);
                    doc.setTextColor(...COLOR_TEXT);
                    const dateRange = formatDate(edu.startDate) + ' - ' + formatDate(edu.endDate);
                    doc.text(`${dateRange}`, column1Start, currentYLeft);
                    currentYLeft += LINE_HEIGHT_SINGLE;
                    
                    // School (Size 13, Normal, Gray)
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...COLOR_TEXT);
                    doc.text(edu.school, column1Start, currentYLeft);
                    
                    currentYLeft += 9; // Increased space after entry
                });
            }

            // 5. Courses & Training
            if (state.courses.length > 0) {
                currentYLeft = checkY(15, currentYLeft);
                if (currentYLeft > maxContentY) { doc.addPage(); currentYLeft = margin; }
                currentYLeft = addSectionTitle(column1Start, currentYLeft, 'TRAINING / COURSES');

                doc.setFontSize(13);
                state.courses.forEach(course => {
                    currentYLeft = checkY(12, currentYLeft);
                    if (currentYLeft > maxContentY) { doc.addPage(); currentYLeft = margin; }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...COLOR_TEXT);
                    doc.text(course.name, column1Start, currentYLeft);
                    currentYLeft += 5; // Increased line space
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(...COLOR_TEXT);
                    doc.text(course.institution, column1Start, currentYLeft);
                    currentYLeft += 9; // Increased space after entry
                });
            }

            // 6. Languages (Using the left column)
            if (state.languages.length > 0) {
                currentYLeft = checkY(15, currentYLeft);
                if (currentYLeft > maxContentY) { doc.addPage(); currentYLeft = margin; }
                currentYLeft = addSectionTitle(column1Start, currentYLeft, 'LANGUAGES');

                doc.setFontSize(13);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...COLOR_TEXT);

                const languageLines = state.languages.map(lang => lang.entry).join(' | ');

                const lines = doc.splitTextToSize(languageLines, column1Width);
                doc.text(lines, column1Start, currentYLeft);
                currentYLeft += lines.length * LINE_HEIGHT_DOUBLE + 8; // Use 2.0x line height + extra spacing
            }


            // --- Right Column Sections (Secondary) ---

            // 2. Skills (Simplified: Only "Programming Languages")
            if (state.skills.length > 0) {
                currentYRight = addSectionTitle(column2Start, currentYRight, 'SKILLS');
                doc.setFontSize(13);
                
                currentYRight = checkY(12, currentYRight); 
                if (currentYRight > maxContentY) {
                    doc.addPage();
                    currentYRight = margin;
                    currentYLeft = margin; 
                    doc.text('CONTINUED: SKILLS', column1Start, currentYLeft);
                    currentYLeft += 5;
                    currentYRight = currentYLeft;
                }

                const categoryText = `Programming Languages: `;
                
                // Draw Category (Bold, Orange)
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...COLOR_SECONDARY);
                doc.text(categoryText, column2Start, currentYRight);
                
                // Draw Skills (Normal, Gray)
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...COLOR_TEXT);
                const skillsList = state.skills.map(s => s.name).join(', ');

                // Measure category label width for indentation
                const labelWidth = doc.getStringUnitWidth(categoryText) * 13 / doc.internal.scaleFactor;
                
                const skillLines = doc.splitTextToSize(skillsList, column2Width - labelWidth);
                doc.text(skillLines, column2Start + labelWidth, currentYRight);
                
                currentYRight += skillLines.length * LINE_HEIGHT_DOUBLE + 6; 
            }

            // 3. Key Achievements
            if (state.achievements.length > 0) {
                currentYRight = checkY(15, currentYRight);
                if (currentYRight > maxContentY) {
                    doc.addPage(); currentYRight = margin;
                    currentYLeft = margin;
                }
                currentYRight = addSectionTitle(column2Start, currentYRight, 'KEY ACHIEVEMENTS');

                doc.setFontSize(13);
                state.achievements.forEach(ach => {
                    currentYRight = checkY(25, currentYRight); // Increased check space
                    if (currentYRight > maxContentY) { doc.addPage(); currentYRight = margin; currentYLeft = margin; }
                    
                    // Achievement Name (Size 14, Bold, Orange)
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.setTextColor(...COLOR_SECONDARY);
                    doc.text(ach.name, column2Start, currentYRight);
                    currentYRight += 5;
                    
                    // Description (Bullet points, Size 13, Normal, Gray)
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(13);
                    doc.setTextColor(...COLOR_TEXT);
                    const bulletPoints = ach.description.split('\n').filter(line => line.trim());
                    bulletPoints.forEach(line => {
                        const bulletText = ' ' + line.trim();
                        const bulletLines = doc.splitTextToSize(bulletText, column2Width - 4);
                        
                        doc.text(bulletLines, column2Start + 4, currentYRight);
                        currentYRight += bulletLines.length * LINE_HEIGHT_DOUBLE; // Use 2.0x line height
                    });
                    currentYRight += 6; // Increased space after entry
                });
            }

            // 4. Interests
            if (state.interests.length > 0) {
                currentYRight = checkY(15, currentYRight);
                if (currentYRight > maxContentY) { doc.addPage(); currentYRight = margin; currentYLeft = margin; }
                currentYRight = addSectionTitle(column2Start, currentYRight, 'INTERESTS');
                
                doc.setFontSize(13);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...COLOR_TEXT);
                
                const interestsLine = state.interests.map(i => i.name).join(' | ');
                const lines = doc.splitTextToSize(interestsLine, column2Width);
                doc.text(lines, column2Start, currentYRight);
                currentYRight += lines.length * LINE_HEIGHT_DOUBLE + 8; // Use 2.0x line height + extra spacing
            }


            // --- Final Output ---
            const filename = (p.fullName || 'Resume').replace(/\s+/g, '_') + '.pdf';
            doc.save(filename);
            window.showMessage('PDF generated and downloaded successfully!', 'success');
        };

        // --- Event Listeners ---
        generatePdfBtn.addEventListener('click', () => {
             // 1. Gather Personal Info one last time
            state.personal.fullName = inputs.fullName.value.trim();
            state.personal.roleApplied = inputs.roleApplied.value.trim();
            state.personal.email = inputs.email.value.trim();
            state.personal.phone = inputs.phone.value.trim();
            state.personal.linkedin = inputs.linkedin.value.trim();
            state.personal.github = inputs.github.value.trim();
            state.personal.website = inputs.website.value.trim();
            state.personal.location = inputs.location.value.trim();
            state.personal.summary = inputs.summary.value.trim();
            // state.personal.imageData is already updated by the change listener
            
            if (!state.personal.fullName || state.experience.length === 0) {
                 window.showMessage('Please enter your Full Name and at least one Experience entry before generating the PDF.', 'error');
                 return;
            }

            generatePDFContent();
        });

        // Initialize App
        document.addEventListener('DOMContentLoaded', loadDataLocally);
    </script>
</body>
</html>
